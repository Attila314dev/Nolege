<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kv√≠zszob√°k ‚Ä¢ Lobby</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="wrap">
    <h1>üß† Kv√≠zszob√°k</h1>

    <!-- 1) Szobalista fel√ºl (F≈ën√∂k + Join gomb) -->
    <section class="card">
      <h2>El√©rhet≈ë szob√°k</h2>
      <div class="flex space">
        <button id="refreshRooms">Friss√≠t√©s</button>
        <span class="small mono">Automatikus friss√≠t√©s 5 mp-enk√©nt</span>
      </div>
      <ul id="roomList" class="players topgap"></ul>
      <p class="small mono topgap">A Join gomb megnyom√°sa ut√°n megadod a nicked √©s a szoba jelszav√°t.</p>
    </section>

    <!-- 2) Szoba l√©trehoz√°s alatta -->
    <section class="card">
      <h2>√öj szoba (Admin)</h2>
      <label>Admin nick:
        <input id="adminNick" placeholder="pl. F≈ën√∂k" maxlength="12" />
      </label>
      <label>Szoba jelsz√≥:
        <input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </label>
      <button id="createBtn">Szoba l√©trehoz√°sa</button>
      <p id="createOut" class="mono small"></p>
    </section>

    <!-- 3) Legalul Spectator m√≥d (jelsz√≥ NEM kell) -->
    <section class="card">
      <h2>Spectator m√≥d (TV-re, csak n√©z√©s)</h2>
      <label>Szobak√≥d: <input id="specRoom" maxlength="6" placeholder="pl. ab12cd" /></label>
      <button id="specBtn">Bel√©p√©s spectator-k√©nt</button>
      <p class="small mono">Spectator m√≥dhoz nem kell jelsz√≥.</p>
    </section>
  </main>

  <script>
    // ========== Szobalista ==========
    const roomList = document.getElementById('roomList');
    const refreshBtn = document.getElementById('refreshRooms');

    async function loadRooms(){
      try{
        const res = await fetch('/api/rooms');
        const data = await res.json();
        roomList.innerHTML = (data||[]).map(r => `
          <li>
            <b>${r.id}</b>
            <span class="small">F≈ën√∂k: ${r.admin || '-'}</span>
            <span>${r.players} j√°t√©kos${r.running ? ' ‚Ä¢ folyamatban' : ''}</span>
            <button class="btn" data-room="${r.id}">Join</button>
          </li>
        `).join('') || '<li>(nincs akt√≠v szoba)</li>';

        // Join gombok esem√©nye
        roomList.querySelectorAll('button[data-room]').forEach(btn => {
          btn.onclick = async () => {
            const roomId = btn.getAttribute('data-room');
            const nick = prompt('Nick (3-12 karakter):')?.trim();
            if (!nick || nick.length < 3 || nick.length > 12) return alert('√ârv√©nytelen nick.');
            const password = prompt('Szoba jelsz√≥:')?.trim();
            if (!password) return alert('Jelsz√≥ kell.');

            // REST join
            const res = await fetch('/api/join', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ roomId, password, nick })
            });
            const data = await res.json();
            if (!res.ok) { return alert(data.error || 'Hiba a join-n√°l'); }

            // siker: mehet a szoban√©zet
            const link = `${location.origin}/room.html?room=${roomId}&pw=${encodeURIComponent(password)}&nick=${encodeURIComponent(nick)}`;
            location.href = link;
          };
        });
      }catch(e){
        roomList.innerHTML = '<li>(nem el√©rhet≈ë)</li>';
      }
    }
    refreshBtn.onclick = loadRooms;
    loadRooms(); setInterval(loadRooms, 5000);

    // ========== Szoba l√©trehoz√°s ==========
    const createBtn = document.getElementById('createBtn');
    const createOut = document.getElementById('createOut');
    createBtn.onclick = async () => {
      const adminNick = document.getElementById('adminNick').value.trim();
      const password = document.getElementById('adminPass').value.trim();
      if (!adminNick || !password) { createOut.textContent = "Add meg a nevet √©s jelsz√≥t"; return; }

      const res = await fetch('/api/createRoom', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ password, adminNick })
      });
      const data = await res.json();
      if (!res.ok) { createOut.textContent = data.error || 'Hiba'; return; }
      const roomId = data.roomId;
      const link = `${location.origin}/room.html?room=${roomId}&admin=1&pw=${encodeURIComponent(password)}&nick=${encodeURIComponent(adminNick)}`;
      createOut.textContent = `K√©sz! Szobak√≥d: ${roomId}`;
      setTimeout(()=> location.href = link, 700);
    };

    // ========== Spectator ==========
    document.getElementById('specBtn').onclick = () => {
      const room = document.getElementById('specRoom').value.trim().toLowerCase();
      if(!room) return alert('Add meg a szobak√≥dot');
      // jelsz√≥ NEM kell
      location.href = `${location.origin}/room.html?room=${room}&spectator=1`;
    };
  </script>
</body>
</html>
